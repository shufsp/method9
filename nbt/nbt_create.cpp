#include <fmt/core.h>
#include <fstream>
#include <vector>
#include <filesystem>
#include <string>
#include "NBTWriter.h"
#include "nbt_create.h"
#include "nbt_adapt.h"

namespace fs = std::filesystem;

static const std::string PIRATES_ICON_BASE64 = "/9j/4AAQSkZJRgABAQIAJQAlAAD/4QCuRXhpZgAASUkqAAgAAAAHABIBAwABAAAAAQAAABoBBQABAAAAYgAAABsBBQABAAAAagAAACgBAwABAAAAAwAAADEBAgANAAAAcgAAADIBAgAUAAAAgAAAAGmHBAABAAAAlAAAAAAAAAAlAAAAAQAAACUAAAABAAAAR0lNUCAyLjEwLjM0AAAyMDIzOjA5OjI0IDExOjAwOjA4AAEAAaADAAEAAAABAAAAAAAAAP/hDM9odHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IlhNUCBDb3JlIDQuNC4wLUV4aXYyIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wTU09Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9tbS8iIHhtbG5zOnN0RXZ0PSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvc1R5cGUvUmVzb3VyY2VFdmVudCMiIHhtbG5zOmRjPSJodHRwOi8vcHVybC5vcmcvZGMvZWxlbWVudHMvMS4xLyIgeG1sbnM6R0lNUD0iaHR0cDovL3d3dy5naW1wLm9yZy94bXAvIiB4bWxuczp4bXA9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC8iIHhtcE1NOkRvY3VtZW50SUQ9ImdpbXA6ZG9jaWQ6Z2ltcDplOWRmY2Q0OC1kZjQ3LTRlYmMtOGU2MC1hZDE4MThlZGE5N2EiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6ZDBhZWE0ZjUtZjNhZi00ZjViLWEyOGMtODg2NmVmN2U1YjgzIiB4bXBNTTpPcmlnaW5hbERvY3VtZW50SUQ9InhtcC5kaWQ6YTMzYTA0OTEtMzYzYy00NTM5LTg1ZTgtYzFkOTEyNjQzMDU3IiBkYzpGb3JtYXQ9ImltYWdlL2pwZWciIEdJTVA6QVBJPSIyLjAiIEdJTVA6UGxhdGZvcm09IkxpbnV4IiBHSU1QOlRpbWVTdGFtcD0iMTY5NTU3MTIxMTM2NTg5MSIgR0lNUDpWZXJzaW9uPSIyLjEwLjM0IiB4bXA6Q3JlYXRvclRvb2w9IkdJTVAgMi4xMCIgeG1wOk1ldGFkYXRhRGF0ZT0iMjAyMzowOToyNFQxMTowMDowOC0wNTowMCIgeG1wOk1vZGlmeURhdGU9IjIwMjM6MDk6MjRUMTE6MDA6MDgtMDU6MDAiPiA8eG1wTU06SGlzdG9yeT4gPHJkZjpTZXE+IDxyZGY6bGkgc3RFdnQ6YWN0aW9uPSJzYXZlZCIgc3RFdnQ6Y2hhbmdlZD0iLyIgc3RFdnQ6aW5zdGFuY2VJRD0ieG1wLmlpZDo3ZTA3YjNlMC03ZmFiLTRmMDItOTgyZi0xZWEzMmEwMDUzNDAiIHN0RXZ0OnNvZnR3YXJlQWdlbnQ9IkdpbXAgMi4xMCAoTGludXgpIiBzdEV2dDp3aGVuPSIyMDIzLTA5LTI0VDExOjAwOjExLTA1OjAwIi8+IDwvcmRmOlNlcT4gPC94bXBNTTpIaXN0b3J5PiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8P3hwYWNrZXQgZW5kPSJ3Ij8+/+ICsElDQ19QUk9GSUxFAAEBAAACoGxjbXMEQAAAbW50clJHQiBYWVogB+cACQAYAA8AOgAsYWNzcEFQUEwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAPbWAAEAAAAA0y1sY21zAAAAAAAAAAAAAAAAAAAAAAAAAAAA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";


std::vector<server> txt_get_servers(const std::string_view path)
{
    std::ifstream txt_input{ path.data() };
    if (!txt_input.is_open())
        return {};

    std::vector<server> servers;
    std::string server_ip;
    int server_index = 0;
    while (std::getline(txt_input, server_ip))
        servers.push_back(server{ fmt::format("WHITELIST YOUR SERVER JOE #{}", ++server_index), PIRATES_ICON_BASE64, server_ip, 0, 0});
    txt_input.close();

    return servers;
}

void nbt_create_with(const std::string_view path, const std::vector<server>& servers)
{
     if (servers.empty())
         return;
     NBT::NBTWriter writer(path.data());
     adapt_nbt_to_version(v1_20, writer, servers);
     writer.close();
}

int main(int argc, char** argv)
{
    if (argc < 3)
    {
        fmt::print("Usage: nbt-creator <path to txt with list of ips> <output .dat path>\n");
        return -1;
    }


    const std::string_view txt_path = argv[1];
    if (txt_path.empty() || txt_path.length() > 256)
    {
        fmt::print("Invalid path or path is too long\n");
        return -2;
    }


    if (!fs::exists(txt_path))
    {
        fmt::print("File \"{}\" doesn't exist", txt_path);
        return -3;
    }

    const std::string_view output_dat_path = argv[2];
    if (output_dat_path.empty())
    {
        fmt::print("Invalid output path\n");
        return -4;
    }

    fmt::print("Creating server entries ...\n");
    const std::vector<server> servers = txt_get_servers(txt_path);
    
    fmt::print("Adding NBT data for server ips to .dat ...\n");
    nbt_create_with(output_dat_path, servers);
    fmt::print("Wrote {} servers to \"{}\"\n", servers.size(), output_dat_path);

    return 0;
}
